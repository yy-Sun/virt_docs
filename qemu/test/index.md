## qemu 测试框架

QEMU的测试框架结构较为复杂，涵盖从单元测试、子系统专项测试到完整功能测试的全方位验证体系。要查看所有可用测试的概览信息，可在源码目录或构建目录中执行`make check-help`命令。

虽然大部分（非全部）测试已集成到meson构建系统的自动化测试体系中，因此可直接在构建目录中运行。例如：

```bash
[./pyvenv/bin/]meson test --suite qemu:softfloat
```

将仅运行 `softfloat` 相关测试。

自动化测试需通过测试框架提供的通用测试函数/类进行编写。测试框架负责执行测试用例并反馈成功或失败状态[1]。一个自动化测试通常包含三个核心组成部分：

1. **测试参数初始化**
   设置预期参数，包括输入值和期望结果；
2. **调用被测代码**
   执行待验证的目标代码段；
3. **断言验证**
   将实际运行结果与初始化阶段设定的期望结果进行比对。若结果符合预期则测试成功，否则标记为失败。

本文档后续章节将针对具体测试类别的实现细节进行深入说明。

###  一、使用 `make check` 进行测试

`make check` 测试系列涵盖了 QEMU 中大多数基于 C 的测试。

通常运行这些测试的方式是：

```bash
make check
```

该命令会执行以下测试：

- QAPI 模式测试
- 单元测试
- `QTests`
- 部分 `iotests`

下文将详细解释 `make check` 中不同类型的测试。

>! **建议在运行测试前先完成 QEMU 程序的编译**。部分测试需要依赖已生成的可执行文件，如果找不到这些文件，可能会报出难以理解的错误信息。

#### 1.1、Unit test

单元测试旨在以独立单元的形式对单个软件组件(如接口、数据结构和功能)进行验证，以发现组件边界内的错误。其验证对象是最小软件单元，重点关注内部处理逻辑和数据结构。单元测试用例的设计需要能揭示由错误计算、不正确比较或异常控制流引发的缺陷[2]。

在QEMU项目中，可通过执行`make check-unit`命令调用单元测试。这些测试是使用C语言编写的简单测试程序，通常链接到单个QEMU目标文件，并通过调用导出函数来验证其功能。

若您需要为QEMU新增代码编写测试，建议优先考虑为以下情况添加单元测试：特别是针对相对无状态或依赖较少的工具模块。以下是添加新单元测试的步骤指南：

创建测试源文件
例如在 `tests/unit/` 目录下新建 `foo-test.c` 文件。

- 编写测试逻辑

- 包含待测模块的API头文件

- 验证接口行为是否符合预期

- 测试代码需基于glib测试框架组织结构

> ?建议复制现有测试案例并进行适配修改

集成到构建系统
在`tests/unit/meson.build`文件中，所有单元测试均列于名为tests的字典结构中。每个条目需指定额外源文件和依赖项。对于简单的测试用例（如源码位于`tests/unit/foo-test.c`的情况），只需添加如下条目：
```meson
'foo-test': files('foo-test.c'),
```
由于单元测试无需依赖环境变量，调试测试失败的最简方法通常是直接运行测试程序，甚至通过 gdb进行调试。但需注意，通过make调用与手动运行之间仍可能存在行为差异，这源于以下两个因素：

- `$MALLOC_PERTURB_` 环境变量（影响内存回收机制，可更有效地捕获无效指针）

- `gtester`工具的配置选项

若需消除这些差异，可通过以下方式运行测试（示例）：
```bash
MALLOC_PERTURB_=0 ./tests/unit/foo-test # 禁用内存扰动检测
```
或通过 `gtester` 指定详细日志模式：

```bash
gtester -v --keep-going tests/unit/foo-test
```
此方法可保留测试临时文件辅助调试。

#### 1.2、编写可移植的测试用例

单元测试和 `QTest` 测试既可在 `POSIX` 主机运行，也可在`Windows`主机运行。编写能跨平台成功构建和运行的测试用例时需特别注意以下事项：

##### 最佳实践指南

1. **优先使用glib可移植API**
   - 环境变量操作：`g_setenv()`
   - 目录创建：`g_mkdtemp()`, `g_mkdir()`
2. **临时目录处理**
   - 避免硬编码`/tmp`路径
   - 使用`g_get_tmp_dir()`获取系统临时目录
3. **特殊设备文件差异**
   - Windows使用特殊表示法：
     - 标准错误：用`"2"`替代Linux的`"/dev/fd/2"`
     - 空设备：用`"nul"`替代Linux的`"/dev/null"`
   - 注意：Windows不支持`"2>nul"`这类IO重定向语法
4. **`blkdebug`功能注意事项**
   - 使用相对路径传递配置文件和镜像路径
   - Windows绝对路径中的`":"`会干扰blkdebug解析器
5. **命令行参数格式**
   - QEMU额外参数请使用双引号`""`
   - Windows不会自动去除单引号`''`，可能导致参数解析错误
6. **文件模式差异**
   - Windows默认以文本模式打开文件
   - 如需二进制读写：
     - `fopen()`需添加`'b'`标志（如`"wb"`）
     - `open()`
     - 
     - 需使用`O_BINARY`标志
7. **平台限定测试处理**
   - 仅限POSIX/Linux的测试：使用`#ifdef`条件编译
   - 完全不支持Windows的测试套件：在`meson.build`中禁用构建

#### 1.3、QAPI 模式测试

QAPI模式测试通过向解析器提供预定义的输入数据，并将其输出结果与参考值进行比对，用于验证QMP所使用的QAPI解析器的正确性。

##### 测试文件结构

测试数据文件存放于`tests/qapi-schema`目录下，每个测试用例包含四个具有相同基础名称的文件：

- **`${casename}.json`**
  包含待解析的JSON输入数据
- **`${casename}.out`**
  记录解析器预期的标准输出内容
- **`${casename}.err`**
  记录解析器预期的错误输出内容
- **`${casename}.exit`**
  指定预期的退出状态码

##### 新增测试用例指南

当您对QAPI解析器进行修改时（包括错误修复或语法扩展/调整），建议按以下步骤添加新的测试用例：

1. **创建测试文件**
   例如使用命令创建一组测试文件：

   ```bash
   $EDITOR tests/qapi-schema/foo.{json,out,err,exit}
   ```

2. **注册测试用例**
   在`tests/Makefile.include`中添加对应条目，例如：

   ```makefile
   qapi-schema += foo.json
   ```

#### 1.4、块设备测试（check-block）

执行`make check-block`将运行块设备层级的 `iotest`测试子集（仅包含"auto"分组的测试用例）。